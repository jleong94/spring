<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.EmailMapper">

  <resultMap id="EmailResultMap" type="com.model.Email">
        <id property="mail_id" column="mail_id"/>
        <result property="created_datetime" column="created_datetime"/>
        <result property="modified_datetime" column="modified_datetime"/>
        <result property="sender" column="sender"/>
        <result property="receiver" column="receiver"/>
        <result property="cc" column="cc"/>
        <result property="bcc" column="bcc"/>
        <result property="subject" column="subject"/>
        <result property="body" column="body"/>
        <result property="isSend" column="isSend"/>

        <collection property="attachments" ofType="com.model.EmailAttachment" 
                    columnPrefix="att_" notNullColumn="attachment_id">
            <id property="attachment_id" column="attachment_id"/>
            <result property="file_path" column="file_path"/>
            <association property="email" javaType="com.modal.Email">
		            <id property="mail_id" column="mail_id"/>
		        </association>
        </collection>
    </resultMap>
    
    <!-- Paginated query with proper filtering -->
    <select id="findEmailByMailId" resultMap="EmailResultMap" timeout="10">
        SELECT 
            e.mail_id,
            e.created_datetime,
            e.modified_datetime,
            e.sender,
            e.receiver,
            e.cc,
            e.bcc,
            e.subject,
            e.body,
            e.isSend,
            a.attachment_id,
            a.file_path,
            a.mail_id
        FROM email e
        LEFT JOIN email_attachment a ON e.mail_id = a.mail_id
        WHERE 1 = 1
        <if test="filter.mail_id != null">
            AND e.mail_id = #{mail_id}
        </if>
        ORDER BY e.created_datetime DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
</mapper>